name: Flutter CI/CD

on:
  push:
    branches: [ '**' ]  # 所有分支都触发
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # 每天格林尼治时间 0 点运行（UTC 0）
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

env:
  FLUTTER_VERSION: '3.38.6'  # 指定 Flutter 版本

jobs:
  analyze-test:
    name: Analyze and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Get packages
      run: flutter pub get

    - name: Analyze code
      run: flutter analyze

    - name: Run tests
      run: flutter test

  nightly-build:
    name: Nightly Build
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Get packages
      run: flutter pub get

    - name: Build for Android
      run: flutter build apk --release --split-per-abi
      
    - name: Build for Web
      run: flutter build web --release

    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nightly-android-build
        path: build/app/outputs/flutter-apk/
        if-no-files-found: error

    - name: Upload Web artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nightly-web-build
        path: build/web/
        if-no-files-found: error