# 项目规范

## 要求
- 所有列入该规范的要求除非**特殊标注**否则强制执行
- 该规范允许修改，修改需按照**DECISION.md**的规则进行

## 具体规范
### 编码规范 Dart/Flutter
- 空安全与错误处理：
    所有代码必须开启空安全（sound null safety）。
    禁止使用 ! 进行空断言（null assertion），必须使用空检查（?）、空合并（??）或条件表达式明确处理。特殊情况需在 SPECIAL.md 声明。
    Future 必须处理可能的错误，禁止在 async 函数中不处理 try-catch 就 await。网络、文件等I/O操作必须有错误处理和用户提示。

- 类型与可读性：
    顶级变量、字段、参数必须显式声明类型，禁止依赖类型推断（局部变量可视情况放宽）。
    尽可能使用 final 声明不可变变量，仅在状态需要改变时使用 var。
    避免使用 dynamic，优先使用泛型或创建特定类型。例外需在 SPECIAL.md 声明。

- 异步编程：
    使用 async/await 替代原始的 .then() 调用链，以保持代码可读性。
      禁止在 initState() 等同步上下文中直接 await，应使用 WidgetsBinding.instance.addPostFrameCallback 或创建独立异步方法。
- 代码风格与格式化：
      所有代码必须使用 dart format 格式化，并遵循官方 Dart 风格指南。
      所有公有API（包括库、类、公开方法/属性）必须包含文档注释（///）。
- Widget 构建规范：
      当 Widget 树深度增加或方法体过长时，必须将子组件抽取为独立方法或 StatelessWidget。
      使用 const 构造函数构建所有静态的、无状态的 Widget，以提高性能。
      禁止在 build() 方法中执行耗时操作或创建非 const 的大对象。
- 状态管理（核心）：
      小型或简单页面可使用内置的 StatefulWidget 和 setState。
      对于具有复杂业务逻辑、跨组件/页面共享状态的场景，统一使用 riverpod 作为状态管理解决方案。禁止混用其他方案（如 provider、get_it 等）。
- 测试与文档：
      每个核心业务逻辑（Dart类、函数）和每个 Widget 必须配备单元测试。
      每个公开的 API 必须有文档注释，并使用 dart doc 生成文档。
- 代码质量工具：
      提交前必须通过 dart analyze 静态分析且无警告。
      对于 dart analyze 或 linter 规则的误报或需要豁免的情况，必须在代码旁添加详细注释说明，并在 SPECIAL.md 中集中声明。
- Flutter 特定：
      禁止在 Widget 中直接使用硬编码的字符串、颜色、尺寸等。必须统一在 lib/constants/ 或 lib/theme/ 下定义常量或主题。
      图片、字体等资源必须在 pubspec.yaml 中声明，并通过生成的 R 类（若使用 flutter_gen）或常量路径访问。
### 编码规范通用
1. 一个函数**只做一件事**，禁止超过**200行**，特殊情况**详细注释**并且在**SPECIAL.md**里声明
2. **模块化**设计，严禁**鱼龙混杂**
3. 每个函数**配备注释**，非前端函数**配备测试**
4. 不和**语言规则**斗争，特殊情况**详细注释**并且在**SPECIAL.md**里声明
### 决策规范
1. 重大决策**写入DECISION.md**中，详见**2条**
2. 重大决策：**工具链转换**、**更改指定文档如本文档**、**其他规定的特殊情况**
3. 写入后**进行评估**，成功则**2天后重新评估**，依旧成功**2天后最终评估**，通过则采用
4. 写入时列清**优势**与**代价**
5. 在**8.0.0版本**发布前，不进行**任何新的重写**
6. 决策**评估失败后**不删除
### 尝鲜规范
1. 可以在**独立目录**中尝鲜，例如**学习新语言**、**尝试新工具链**等
2. 不允许**复制代码**进本项目，除非**Clippy**检查通过
3. 不影响**主项目及其他项目进度**
### 备份规范
1. 不改变系统**定时备份机制**
2. 使用Git**进行版本控制**，严禁**删除版本库重建**
3. 每天创建快照并保存至**移动硬盘**
4. 每天结束确保**所有分支同步到Github**
### SPECIAL结构要求
每个例外必须包含：
```markdown
# [文件名]:[行号] - [规则编号]
**日期**: YYYY-MM-DD
**违反规则**: STANDARD.md第X条第X款
**详细原因**: 
**解决方案**: 
**预计修复时间**: 
**负责人**: [你的名字]
```
### Git规范
1. 分阶段**开发**，每个阶段**设置单独分支**
2. `feature`分支：新功能**实现并测试后**合并
3. `dev`分支：新功能可以到达**beta标准**后合并
4. `main`分支：新功能**稳定后**合并
### 术语定义
1. **业务函数**: 包含核心业务逻辑、需要测试覆盖的公开函数
2. **工具函数**: 不包含业务逻辑的辅助函数，仍需测试但可降低覆盖率要求
3. **前端函数**: Vue组件中的组合式函数和工具函数
4. **测试用例**: 至少包含正常流程和1个异常流程的测试
### 测试规范
**基本组件测试必须包含**:
1. **渲染测试**: 验证组件能正常渲染
2. **Props测试**: 验证Props能正确影响组件行为  
3. **交互测试**: 验证至少1个用户交互能正常工作
4. **边界测试**: 验证异常情况下的行为 (如空数据、错误状态)

**示例不通过**:
```typescript
// ❌ 不通过: 过于简单
it('renders', () => {
  render(MyComponent)
})

// ✅ 通过: 有具体断言
it('should display user name when user prop is provided', () => {
  const wrapper = render(MyComponent, {
    props: { user: { name: '张三' } }
  })
  expect(wrapper.getByText('张三')).toBeInTheDocument()
})
```
